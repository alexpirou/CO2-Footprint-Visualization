<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Population plot placeholder</title>
</head>
<body>
    <svg width="1000" height="1000" id="chart"></svg>
    <script>
        const svg = d3.select("svg");
        const width = svg.attr("width");
        const height = svg.attr("height");
        const margin = {top: 50, right: 100, bottom: 50, left: 100};
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;

        let annotations = svg.append("g").attr("id","annotations");
        let chartArea = svg.append("g").attr("id","points")
                           .attr("transform",`translate(${margin.left},${margin.top})`);

        d3.csv("world_population.csv", d3.autotype)
          .then((data) => {
            
            console.log(data);

            let populationYear = "2022 Population"; //Controls year being evaluated
            data.forEach( d => {
            d[populationYear] =  Number(d[populationYear]);
            });

            //Take the top countries
            const topCountries = data.sort((a,b) => b[populationYear] - a[populationYear]).slice(0, 10);

            console.log(topCountries);
            console.log('hello');
            console.log(d3.max(topCountries, d => d[populationYear]));

            // Define scales
            const populationScale = d3.scaleLinear()
                                      .domain([0, d3.max(topCountries, d => d[populationYear])])
                                      .range([0, chartWidth]);

            const countryScale = d3.scaleBand()
                                   .domain(topCountries.map(d => d['Country/Territory']))
                                   .range([0, chartHeight])
                                   .padding(0.5);

            const colorScale = d3.scaleOrdinal(d3.schemeCategory10); //Color scale

            //Create axes and gridlines
            let leftAxis = d3.axisLeft(countryScale);
            let leftGridlines = d3.axisLeft(countryScale).tickSize(-chartWidth-10).tickFormat("");
            annotations.append("g")
                       .attr("class", "y axis")
                       .attr("transform",`translate(${margin.left-10},${margin.top})`)
                       .call(leftAxis)
            annotations.append("g")
                       .attr("class", "y gridlines")
                       .attr("transform",`translate(${margin.left-10},${margin.top})`)
                       .call(leftGridlines);

            let bottomAxis = d3.axisBottom(populationScale)
                               .tickFormat(d3.format(".2s"));
            let bottomGridlines = d3.axisBottom(populationScale)
                                    .tickSize(-chartHeight-10)
                                    .tickFormat("");
            annotations.append("g")
                       .attr("class", "x axis")
                       .attr("transform",`translate(${margin.left},${chartHeight+margin.top+10})`)
                       .call(bottomAxis);
            annotations.append("g")
                       .attr("class", "x gridlines")
                       .attr("transform",`translate(${margin.left},${chartHeight+margin.top+10})`)
                       .call(bottomGridlines);

            //Add title
            chartArea.append("text")
                     .attr("x", chartWidth / 2)
                     .attr("y", margin.top - 75)
                     .attr("text-anchor", "middle")
                     .attr("font-size", "28px")
                     .text(populationYear);

            //Plot the rectangles. This is where we will make the changes for narrowing down to a single country for the user
            chartArea.selectAll('rect.bar').data(topCountries)
                     .join('rect').attr('class','bar')
                     .attr("x", 0)
                     .attr("y", d => countryScale(d['Country/Territory']))
                     .attr("fill", d => colorScale(d['Country/Territory']))
                     .attr("width", d => Math.min(populationScale(d[populationYear]), chartWidth))
                     .attr("height", countryScale.bandwidth());

            // Add population text inside each bar
            chartArea.selectAll('text.population').data(topCountries)
                 .join('text').attr('class', 'population')
                 .attr("x", d => populationScale(d[populationYear]) - 70)
                 .attr("y", d => countryScale(d['Country/Territory']) + countryScale.bandwidth() / 2 + 5)
                 .attr("fill", "black")
                 .attr("font-size", "12px")
                 .attr("text-anchor", "start")
                 .text(d => d3.format(",")(d[populationYear]));
    })
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Population vs CO2 Emissions Analysis</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  
  <style>
    .gridlines line {
      stroke: #bbb;
    }

    .gridlines .domain {
      stroke: none;
    }
  </style>
</head>

<body>
  <svg id="co2" height="800" width="1200" style="background: #fff; margin-top: 50px"></svg>
  <svg id="population-chart" height="500" width="1200" style="background: #fff; margin-top: 50px"></svg>

<script>
  async function requestData() {
    //Load TopoJSON (world map), CSV (COâ‚‚ emissions and population) data
    const world = await d3.json("./countries-110m.json");
    const co2_emissions = await d3.csv("./co2_emissions_kt_by_country.csv", d3.autoType);
    const population_data = await d3.csv("world_population.csv", d3.autoType);
    const country_coordinates = await d3.csv("./country-coordinates.csv", d3.autoType);
    console.log(country_coordinates); // Check the structure and field name
  
    //CO2 Map basic setup
    const co2_svg = d3.select("#co2");
    const co2_width = co2_svg.attr("width");
    const co2_height = co2_svg.attr("height");
    const co2_map = co2_svg.append("g");

    //Set projection and path for the map
    const projection = d3.geoMercator()
                         .scale(200)
                         .translate([co2_width / 2, co2_height / 1.4]);

    const path = d3.geoPath().projection(projection);

    //Convert TopoJSON to GeoJSON for countries
    const countries = topojson.feature(world, world.objects.countries).features;
    
    // Draw country outlines
    co2_map.selectAll("path")
             .data(countries)
             .join("path")
             .attr("d", path)
             .attr("fill", "#eee")
             .attr("stroke", "#333");

      // Map country codes to latitude and longitude coordinates
      const country_coordinates_map = new Map(country_coordinates.map(d => [d.name, [d.longitude, d.latitude]]));
      console.log(country_coordinates_map);

      // CO2 emissions conversions for projection
      const co2DataWithCoords = [];
      co2_emissions.forEach(d => {
        const coordinates = country_coordinates_map.get(d.country_name);
            if (coordinates) {
                co2DataWithCoords.push({
                value: d.value,
                position: projection(coordinates),
                });
            }
       });

       console.log(co2DataWithCoords);

      // Contour Generator
      let contourGen = d3.contourDensity()
                           .x(d => d.position[0])
                           .y(d => d.position[1])
                           .size([co2_width, co2_height])
                           .thresholds(20)
                           .bandwidth(20); 

      // Run generator
      let contours = contourGen(co2DataWithCoords);

      console.log(contours)

      // Set up color scale based on CO2 values
      let valueExtent = d3.extent(contours, d => d.value);
      let colorScale = d3.scaleSequential(d3.interpolateReds).domain(valueExtent);
      const layer = co2_map.append("g");

      // Draw contours
      layer.selectAll("path.contours")
             .data(contours)
             .join("path")
             .attr("class", 'contours')
             .attr("fill", d => colorScale(d.value))
             .attr("d", d3.geoPath())
             .attr("stroke", "none")
             .attr("opacity", 1);

      // Overlay country borders on top of contours for visibility
      co2_map.selectAll("path.country-border")
             .data(countries)
             .join("path")
             .attr("class", "country-border")
             .attr("d", path)
             .attr("fill", "none")
             .attr("stroke", "#333")
             .attr("stroke-width", 0.7);
    }
    
    requestData();

</script>

</body>
</html>